/*!
 * factor-network.js v1.0.1
 * (c) 2017-12-26 Jade Gu
 * Released under the MIT License.
 * @license
 */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.FactorNetwork=n()}(this,function(){"use strict";function t(){return 2*Math.random()-1}function n(){return Math.random()<=.5}function e(t){return t}function r(t){return Math.max(0,t)}function i(t){return t<=0?0:1}function o(t){return 1/(1+Math.exp(-t/1))}function a(t){return t*(1-t)}function u(t){if(t===1/0)return 1;if(t===-(1/0))return-1;var n=Math.exp(2*t);return(n-1)/(n+1)}function c(t){return 1-t*t}function s(n){for(var e=[],r=n[0],i=1;i<n.length;i++){for(var o=[],a=0;a<n[i];a++){for(var u=[],c=0;c<r;c++){var s=t();u.push(s)}o.push(u)}r=o.length,e.push(o)}return e}function h(t,n){for(var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"SIGMOID",r=n,i=[n.concat()],o=0;o<t.length;o++){for(var a=t[o],u=[],c=0;c<a.length;c++){for(var s=a[c],h=0,l=0;l<s.length;l++){var v=s[l];h+=r[l]*v}var d=f(e,o).output(h);u.push(d)}i.push(u),r=u}return i}function f(t,n){return"string"==typeof t?A[t]:Array.isArray(t)?A[t[n]]:void 0}function l(t,n){for(var e=0;e<t.length;e++)for(var r=t[e],i=0;i<r.length;i++)for(var o=r[i],a=0;a<o.length;a++){var u=o[a];n({weight:u,node:o,layer:r,network:t,path:[e,i,a]})}}function v(t){return JSON.parse(JSON.stringify(t))}function d(t,n){return JSON.stringify(t)===JSON.stringify(n)}function g(t){function n(){return f}function e(t){f=t}function r(t){return l=h(f,t,c.activation)}function i(t,n){var e=r(n);return c.output(e[e.length-1])}function o(t){for(var n=[],e=l[l.length-1],r=0;r<t.length;r++){var i=e[r]-t[r];n.push(i)}return p(f,n)}function a(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:c.learningRate,e=o(t);m(f,l,e,c.activation,n)}function u(t,n){r(t),a(n)}var c=Object.assign({},M,t),f=s(c.network),l=null;return{options:c,getNetwork:n,replaceNetwork:e,compute:r,adjust:a,train:u,output:i}}function p(t,n){for(var e=[n.concat()],r=n,i=t.length-2;i>=0;i--){for(var o=t[i],a=t[i+1],u=[],c=o.length-1;c>=0;c--){for(var s=0,h=a.length-1;h>=0;h--){var f=a[h][c];s+=r[h]*f}u.unshift(s)}e.unshift(u),r=u}return e}function m(t,n,e,r,i){l(t,function(o){var a=o.path,u=t[a[0]][a[1]][a[2]],c=n[a[0]][a[2]],s=n[a[0]+1][a[1]],h=e[a[0]][a[1]],l=f(r,a[0]),v=-i*h*c*l.derivative(s),d=u+v;t[a[0]][a[1]][a[2]]=d})}function k(t){function n(t){for(var n=0;n<t;n++){var e=s(l.network);d.push(e)}l.amount=d.length}function e(t){d.forEach(t)}function r(t){var e=d.length;e>t?(d.length=t,l.amount=t):e<t&&n(t-e)}function i(){return d}function o(t){d=t}function a(t){for(var n=[],e=0;e<t.length;e++)n.push(d[t[e]]);d=n,l.amount=d.length}function u(t,n){return h(d[t],n,l.activation)}function c(t,n){var e=u(t,n);return l.output(e[e.length-1])}function f(t){t&&a(t);for(var n=[],e=Math.round(l.elitismRate*l.amount),r=0;r<e;r++)n.push(d[r]);for(var i=Math.round(l.randomRate*l.amount),o=0;o<i;o++)n.push(s(l.network));for(var u=0;;){for(var c=0;c<u;c++)for(var h=0;h<l.mixNumber;h++){var f=y(v(d[c]),d[u],l.mutation);if(n.push(f),n.length>=l.amount)return n.length=l.amount,void(d=n)}u++,u===d.length&&(u=0)}}var l=Object.assign({},b,t),d=[];return n(l.amount),{options:l,createNetworks:n,eachNetwork:e,getNetworks:i,replaceNetworks:o,sortNetworks:a,updateAmount:r,compute:u,adjust:f,output:c}}function y(e,r,i){return l(e,function(o){var a=o.path;if(n()){var u=r[a[0]][a[1]][a[2]];e[a[0]][a[1]][a[2]]=u}Math.random()<=i.rate&&(e[a[0]][a[1]][a[2]]+=i.range*t())}),e}var A={RELU:{output:r,derivative:i},SIGMOID:{output:o,derivative:a},TANH:{output:u,derivative:c}},w=Object.freeze({create:s,compute:h,getActivation:f,walk:l,copy:v,isEqual:d}),M={network:[2,2,1],activation:"SIGMOID",learningRate:.1,output:e},b={network:[2,2,1],amount:50,elitismRate:.2,randomRate:.2,mixNumber:1,mutation:{rate:.1,range:.5},activation:"SIGMOID",output:e},S=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},x=function(){function t(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(n,e,r){return e&&t(n.prototype,e),r&&t(n,r),n}}(),N=function(){function t(n){S(this,t),this.originalBoard=n,this.statistic=[]}return x(t,[{key:"run",value:function(t){for(var n=Number(t);n--;)this.simulate();return this.getBestAction()}},{key:"simulate",value:function(){for(var t=this.originalBoard.clone(),n=t.getActions(),e=[];n.length;){var r=n[Math.floor(Math.random()*n.length)];e.push(r),t.doAction(r),n=t.getActions()}this.updateStatistic(e[0],t.getResult())}},{key:"updateStatistic",value:function(t,n){var e=this.statistic.find(function(n){return n.action===t});e?e.score+=n:this.statistic.push({action:t,score:n})}},{key:"getBestAction",value:function(){return this.statistic.reduce(function(t,n){return n.score>t.score?n:t}).action}}]),t}(),B=function(){function t(n){S(this,t),this.originalBoard=n,this.board=null}return x(t,[{key:"run",value:function(t){for(var n=Number(t),e=new R(null,this.originalBoard.getActions(),null);n--;){this.board=this.originalBoard.clone();var r=e;r=this.Selection(r),r=this.Expanstion(r),this.Simulation(r),this.Backpropagation(r)}return e.getBestAction()}},{key:"Selection",value:function(t){for(;!t.hasUnexaminedAction()&&t.children.length>0;)t=t.selectChild(),this.board.doAction(t.action);return t}},{key:"Expanstion",value:function(t){if(t.hasUnexaminedAction()){var n=t.getUnexamineActionRandomly();this.board.doAction(n),t=t.addChild(n,this.board.getActions())}return t}},{key:"Simulation",value:function(t){for(var n=this.board.getActions();n.length>0;){var e=n[Math.floor(Math.random()*n.length)];this.board.doAction(e),n=this.board.getActions()}}},{key:"Backpropagation",value:function(t){t.updateStatistic(this.board.getResult())}}]),t}(),R=function(){function t(n,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;S(this,t),this.action=n,this.nextActions=e||[],this.children=[],this.wins=0,this.visits=0,this.parent=r}return x(t,[{key:"isRoot",value:function(){return!this.parent}},{key:"hasUnexaminedAction",value:function(){return this.nextActions.length>0}},{key:"getUnexamineActionRandomly",value:function(){var t=Math.floor(Math.random()*this.nextActions.length);return this.nextActions.splice(t,1)[0]}},{key:"getScore",value:function(){return this.visits>0?this.wins/this.visits:0}},{key:"getBestChild",value:function(){for(var t=this.children[0],n=1;n<this.children.length;n++){var e=this.children[n];e.getScore()>t.getScore()&&(t=e)}return t}},{key:"getBestAction",value:function(){return this.getBestChild().action}},{key:"addChild",value:function(n,e){var r=new t(n,e,this);return this.children.push(r),r}},{key:"selectChild",value:function(){return this.children[Math.floor(Math.random()*this.children.length)]}},{key:"updateStatistic",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.visits+=1,this.wins+=t,this.isRoot()||this.parent.updateStatistic(t)}}]),t}();return{network:w,createBackPropagation:g,createEvolution:k,MCM:N,MCTS:B}});