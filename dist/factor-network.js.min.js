/*!
 * factor-network.js v1.0.1
 * (c) 2018-01-14 Jade Gu
 * Released under the MIT License.
 * @license
 */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.FactorNetwork=n()}(this,function(){"use strict";function t(){return 2*Math.random()-1}function n(){return Math.random()<=.5}function i(t){return t}function e(t){return Math.max(0,t)}function r(t){return t<=0?0:1}function o(t){return 1/(1+Math.exp(-t/1))}function a(t){return t*(1-t)}function s(t){if(t===1/0)return 1;if(t===-1/0)return-1;var n=Math.exp(2*t);return(n-1)/(n+1)}function u(t){return 1-t*t}function h(n){for(var i=[],e=n[0],r=1;r<n.length;r++){for(var o=[],a=0;a<n[r];a++){for(var s=[],u=0;u<e;u++){var h=t();s.push(h)}o.push(s)}e=o.length,i.push(o)}return i}function c(t,n){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"SIGMOID",e=n,r=[n.concat()],o=0;o<t.length;o++){for(var a=t[o],s=[],u=0;u<a.length;u++){for(var h=a[u],c=0,v=0;v<h.length;v++){var f=h[v];c+=e[v]*f}var d=l(i,o).output(c);s.push(d)}r.push(s),e=s}return r}function l(t,n){return"string"==typeof t?B[t]:Array.isArray(t)?B[t[n]]:void 0}function v(t,n){for(var i=0;i<t.length;i++)for(var e=t[i],r=0;r<e.length;r++)for(var o=e[r],a=0;a<o.length;a++){var s=o[a];n({weight:s,node:o,layer:e,network:t,path:[i,r,a]})}}function f(t){return JSON.parse(JSON.stringify(t))}function d(t,n){return JSON.stringify(t)===JSON.stringify(n)}function g(t){function n(){return l}function i(t){l=t}function e(t){return v=c(l,t,u.activation)}function r(t,n){var i=e(n);return u.output(i[i.length-1])}function o(t){for(var n=[],i=v[v.length-1],e=0;e<t.length;e++){var r=i[e]-t[e];n.push(r)}return p(l,n)}function a(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:u.learningRate,i=o(t);k(l,v,i,u.activation,n)}function s(t,n){e(t),a(n)}var u=Object.assign({},N,t),l=h(u.network),v=null;return{options:u,getNetwork:n,replaceNetwork:i,compute:e,adjust:a,train:s,output:r}}function p(t,n){for(var i=[n.concat()],e=n,r=t.length-2;r>=0;r--){for(var o=t[r],a=t[r+1],s=[],u=o.length-1;u>=0;u--){for(var h=0,c=a.length-1;c>=0;c--){var l=a[c][u];h+=e[c]*l}s.unshift(h)}i.unshift(s),e=s}return i}function k(t,n,i,e,r){v(t,function(o){var a=o.path,s=t[a[0]][a[1]][a[2]],u=n[a[0]][a[2]],h=n[a[0]+1][a[1]],c=i[a[0]][a[1]],v=l(e,a[0]),f=-r*c*u*v.derivative(h),d=s+f;t[a[0]][a[1]][a[2]]=d})}function y(t){function n(t){for(var n=0;n<t;n++){var i=h(v.network);d.push(i)}v.amount=d.length}function i(t){d.forEach(t)}function e(t){var i=d.length;i>t?(d.length=t,v.amount=t):i<t&&n(t-i)}function r(){return d}function o(t){d=t}function a(t){for(var n=[],i=0;i<t.length;i++)n.push(d[t[i]]);d=n,v.amount=d.length}function s(t,n){return c(d[t],n,v.activation)}function u(t,n){var i=s(t,n);return v.output(i[i.length-1])}function l(t){t&&a(t);for(var n=[],i=Math.round(v.elitismRate*v.amount),e=0;e<i;e++)n.push(d[e]);for(var r=Math.round(v.randomRate*v.amount),o=0;o<r;o++)n.push(h(v.network));for(var s=0;;){for(var u=0;u<s;u++)for(var c=0;c<v.mixNumber;c++){var l=m(f(d[u]),d[s],v.mutation);if(n.push(l),n.length>=v.amount)return n.length=v.amount,void(d=n)}s++,s===d.length&&(s=0)}}var v=Object.assign({},R,t),d=[];return n(v.amount),{options:v,createNetworks:n,eachNetwork:i,getNetworks:r,replaceNetworks:o,sortNetworks:a,updateAmount:e,compute:s,adjust:l,output:u}}function m(i,e,r){return v(i,function(o){var a=o.path;if(n()){var s=e[a[0]][a[1]][a[2]];i[a[0]][a[1]][a[2]]=s}Math.random()<=r.rate&&(i[a[0]][a[1]][a[2]]+=r.range*t())}),i}function A(t){for(var n=[],i=t[0],e=1;e<t.length;e++){for(var r=[],o=0;o<t[e];o++){for(var a=[],s=0;s<i;s++)a.push([]);r.push(a)}i=r.length,n.push(r)}return n}function w(t,n){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"SIGMOID",e=n,r=[n.concat()],o=0;o<t.length;o++){for(var a=t[o],s=[],u=0;u<a.length;u++){for(var h=a[u],c=0,l=0;l<h.length;l++){var v=Number("0."+h[l].slice(0).join(""));c+=e[l]*v}var f=x(i,o).output(c);s.push(f)}r.push(s),e=s}return r}function x(t,n){return"string"==typeof t?B[t]:Array.isArray(t)?B[t[n]]:void 0}function b(t,n){for(var i=0;i<t.length;i++)for(var e=t[i],r=0;r<e.length;r++)for(var o=e[r],a=0;a<o.length;a++){var s=o[a];n({weight:s,node:o,layer:e,network:t,path:[i,r,a]})}}function S(t){var n=[];return b(t,function(t){return n.push(t.weight)}),n}function M(t){return JSON.parse(JSON.stringify(t))}var B={RELU:{output:e,derivative:r},SIGMOID:{output:o,derivative:a},TANH:{output:s,derivative:u}},C=Object.freeze({create:h,compute:c,getActivation:l,walk:v,copy:f,isEqual:d}),N={network:[2,2,1],activation:"SIGMOID",learningRate:.1,output:i},R={network:[2,2,1],amount:50,elitismRate:.2,randomRate:.2,mixNumber:1,mutation:{rate:.1,range:.5},activation:"SIGMOID",output:i},U=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},I=function(){function t(t,n){for(var i=0;i<n.length;i++){var e=n[i];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(n,i,e){return i&&t(n.prototype,i),e&&t(n,e),n}}(),O=function(){function t(n){U(this,t),this.originalBoard=n,this.statistic=[]}return I(t,[{key:"run",value:function(t){for(var n=Number(t),i=this.originalBoard.getActions(),e=0;e<i.length;e++)for(var r=Math.floor(n/i.length);r--;)this.simulate(i[e]);return this.getBestAction()}},{key:"simulate",value:function(t){var n=this.originalBoard.clone();n.doAction(t);for(var i=n.getActions();i.length;){var e=i[Math.floor(Math.random()*i.length)];n.doAction(e),i=n.getActions()}this.updateStatistic(t,n.getResult())}},{key:"updateStatistic",value:function(t,n){var i=this.statistic.find(function(n){return n.action===t});i?(i.score+=n,i.visited+=1):this.statistic.push({action:t,score:n,visited:1})}},{key:"getBestAction",value:function(){return this.statistic.map(function(t){return{action:t.action,quality:t.score/t.visited}}).reduce(function(t,n){return n.quality>t.quality?n:t}).action}}]),t}(),T=function(){function t(n){U(this,t),this.originalBoard=n,this.board=null}return I(t,[{key:"run",value:function(t){for(var n=Number(t),i=new E(null,this.originalBoard.getActions(),null);n--;){this.board=this.originalBoard.clone();var e=i;e=this.Selection(e),e=this.Expanstion(e),this.Simulation(e),this.Backpropagation(e)}return i.getBestAction()}},{key:"Selection",value:function(t){for(;!t.hasUnexaminedAction()&&t.children.length>0;)t=t.selectChild(),this.board.doAction(t.action);return t}},{key:"Expanstion",value:function(t){if(t.hasUnexaminedAction()){var n=t.getUnexamineActionRandomly();this.board.doAction(n),t=t.addChild(n,this.board.getActions())}return t}},{key:"Simulation",value:function(t){for(var n=this.board.getActions();n.length>0;){var i=n[Math.floor(Math.random()*n.length)];this.board.doAction(i),n=this.board.getActions()}}},{key:"Backpropagation",value:function(t){t.updateStatistic(this.board.getResult())}}]),t}(),E=function(){function t(n,i){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;U(this,t),this.action=n,this.nextActions=i||[],this.children=[],this.wins=0,this.visits=0,this.parent=e}return I(t,[{key:"isRoot",value:function(){return!this.parent}},{key:"hasUnexaminedAction",value:function(){return this.nextActions.length>0}},{key:"getUnexamineActionRandomly",value:function(){var t=Math.floor(Math.random()*this.nextActions.length);return this.nextActions.splice(t,1)[0]}},{key:"getScore",value:function(){return this.visits>0?this.wins/this.visits:0}},{key:"getBestChild",value:function(){for(var t=this.children[0],n=1;n<this.children.length;n++){var i=this.children[n];i.getScore()>t.getScore()&&(t=i)}return t}},{key:"getBestAction",value:function(){return this.getBestChild().action}},{key:"addChild",value:function(n,i){var e=new t(n,i,this);return this.children.push(e),e}},{key:"selectChild",value:function(){return this.children[Math.floor(Math.random()*this.children.length)]}},{key:"updateStatistic",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.visits+=1,this.wins+=t,this.isRoot()||this.parent.updateStatistic(t)}}]),t}(),L=function(){function t(n){U(this,t),this.originalBoard=n,this.board=null}return I(t,[{key:"run",value:function(t){for(var n=Number(t),i=new j(null,this.originalBoard.getActions(),null);n--;){this.board=this.originalBoard.clone();var e=i;e=this.Selection(e),e=this.Expanstion(e),this.Simulation(),this.Backpropagation(e)}return i.getBestAction()}},{key:"Selection",value:function(t){for(;!t.hasUnexaminedAction()&&t.children.length>0;)t=t.selectChild(),this.board.doAction(t.action);return t}},{key:"Expanstion",value:function(t){if(t.hasUnexaminedAction()){var n=t.getUnexamineActionRandomly();this.board.doAction(n),t=t.addChild(n,this.board.getActions())}return t}},{key:"Simulation",value:function(){for(var t=this.board.getActions();t.length>0;){var n=t[Math.floor(Math.random()*t.length)];this.board.doAction(n),t=this.board.getActions()}}},{key:"Backpropagation",value:function(t){t.updateStatistic(this.board.getResult())}}]),t}(),j=function(){function t(n,i){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;U(this,t),this.action=n,this.nextActions=i||[],this.children=[],this.wins=0,this.visits=0,this.parent=e}return I(t,[{key:"isRoot",value:function(){return!this.parent}},{key:"hasUnexaminedAction",value:function(){return this.nextActions.length>0}},{key:"getUnexamineActionRandomly",value:function(){var t=Math.floor(Math.random()*this.nextActions.length);return this.nextActions.splice(t,1)[0]}},{key:"getScore",value:function(){return this.visits>0?this.wins/this.visits:0}},{key:"getBestChild",value:function(){for(var t=this.children[0],n=1;n<this.children.length;n++){var i=this.children[n];i.visits>t.visits?t=i:i.visits===t.visits&&(t=i.wins>t.wins?i:t)}return t}},{key:"getBestAction",value:function(){return this.getBestChild().action}},{key:"getUCTValue",value:function(){return this.getScore()+this.parent.getScore()*Math.sqrt(2*Math.log(this.parent.visits)/this.visits)}},{key:"addChild",value:function(n,i){var e=new t(n,i,this);return this.children.push(e),e}},{key:"selectChild",value:function(){for(var t=this.children[0],n=1;n<this.children.length;n++){var i=this.children[n];i.getUCTValue()>t.getUCTValue()&&(t=i)}return t}},{key:"updateStatistic",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.visits+=1,this.wins+=t,this.isRoot()||this.parent.updateStatistic(t)}}]),t}(),q=function(){function t(n){var i=n.network,e=n.digitLength,r=void 0===e?5:e,o=n.activationType;U(this,t),this.board=new D({network:i,digitLength:r}),this.activationType=o,this.uct=new J(this.board),this.collection=null}return I(t,[{key:"getModelList",value:function(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=function(n){var i=n.board;return function(n){return w(i.network,n,t.activationType)}};return this.collection=this.uct.run(n),this.collection.map(i)}},{key:"handleFeedback",value:function(t){var n=this;t.forEach(function(t,i){var e=n.collection[i],r=e.node,o=e.score;r.fixStatistic(t-o)})}}]),t}(),J=function(){function t(n){U(this,t),this.originalBoard=n,this.board=null,this.root=new V(null,this.originalBoard.getActions(),null)}return I(t,[{key:"run",value:function(t){var n=this;return Array.from({length:Number(t)}).map(function(){return n.runOnce()})}},{key:"runOnce",value:function(){var t=this.root;this.board=this.originalBoard.clone(),t=this.Selection(t),t=this.Expanstion(t),this.Simulation();var n=t.isRoot()?0:t.parent.getScore();return this.Backpropagation(t,n),{score:n,node:t,board:this.board}}},{key:"Selection",value:function(t){for(;!t.hasUnexaminedAction()&&t.children.length>0;)t=t.selectChild(),this.board.doAction(t.action);return t}},{key:"Expanstion",value:function(t){if(t.hasUnexaminedAction()){var n=t.getUnexamineActionRandomly();this.board.doAction(n),t=t.addChild(n,this.board.getActions())}return t}},{key:"Simulation",value:function(){for(var t=this.board.getActions();t.length>0;){var n=t[Math.floor(Math.random()*t.length)];this.board.doAction(n),t=this.board.getActions()}}},{key:"Backpropagation",value:function(t,n){t.updateStatistic(n)}}]),t}(),V=function(){function t(n,i){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;U(this,t),this.action=n,this.nextActions=i||[],this.children=[],this.wins=0,this.visits=0,this.parent=e}return I(t,[{key:"isRoot",value:function(){return!this.parent}},{key:"hasUnexaminedAction",value:function(){return this.nextActions.length>0}},{key:"getUnexamineActionRandomly",value:function(){var t=Math.floor(Math.random()*this.nextActions.length);return this.nextActions.splice(t,1)[0]}},{key:"getScore",value:function(){return this.visits>0?this.wins/this.visits:0}},{key:"getBestChild",value:function(){for(var t=this.children[0],n=1;n<this.children.length;n++){var i=this.children[n];i.visits>t.visits?t=i:i.visits===t.visits&&(t=i.wins>t.wins?i:t)}return t}},{key:"getBestAction",value:function(){return this.getBestChild().action}},{key:"getUCTValue",value:function(){return this.getScore()+this.parent.getScore()*Math.sqrt(2*Math.log(this.parent.visits)/this.visits)}},{key:"addChild",value:function(n,i){var e=new t(n,i,this);return this.children.push(e),e}},{key:"selectChild",value:function(){for(var t=this.children[0],n=1;n<this.children.length;n++){var i=this.children[n],e=i.getUCTValue(),r=t.getUCTValue();e>r?t=i:e===r&&Math.random()>.5&&(t=i)}return t}},{key:"updateStatistic",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.visits+=1,this.wins+=t,this.isRoot()||this.parent.updateStatistic(t)}},{key:"fixStatistic",value:function(t){this.wins+=t,this.isRoot()||this.parent.updateStatistic(t)}}]),t}(),D=function(){function t(n){var i=n.network,e=n.digitLength,r=void 0===e?5:e,o=n.weightIndex,a=void 0===o?0:o,s=n.digitIndex,u=void 0===s?0:s;U(this,t),this.network=A(i),this.weightList=S(this.network),this.digitLength=r,this.weightIndex=a,this.digitIndex=u}return I(t,[{key:"clone",value:function(){var n=Object.assign(Object.create(t.prototype),this);return n.network=M(this.network),n.weightList=S(n.network),n}},{key:"getActions",value:function(){return this.digitIndex<this.digitLength?[0,1,2,3,4,5,6,7,8,9]:[]}},{key:"doAction",value:function(t){this.weightList[this.weightIndex][this.digitIndex]=t,this.weightIndex+=1,this.weightIndex===this.weightList.length&&(this.weightIndex=0,this.digitIndex+=1)}}]),t}();return{network:C,createBackPropagation:g,createEvolution:y,MCM:O,MCTS:T,UCT:L,MCNNS:q}});