/*!
 * factor-network.js v1.0.1
 * (c) 2018-01-01 Jade Gu
 * Released under the MIT License.
 * @license
 */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.FactorNetwork=n()}(this,function(){"use strict";function t(){return 2*Math.random()-1}function n(){return Math.random()<=.5}function i(t){return t}function e(t){return Math.max(0,t)}function r(t){return t<=0?0:1}function o(t){return 1/(1+Math.exp(-t/1))}function a(t){return t*(1-t)}function u(t){if(t===1/0)return 1;if(t===-1/0)return-1;var n=Math.exp(2*t);return(n-1)/(n+1)}function s(t){return 1-t*t}function c(n){for(var i=[],e=n[0],r=1;r<n.length;r++){for(var o=[],a=0;a<n[r];a++){for(var u=[],s=0;s<e;s++){var c=t();u.push(c)}o.push(u)}e=o.length,i.push(o)}return i}function h(t,n){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"SIGMOID",e=n,r=[n.concat()],o=0;o<t.length;o++){for(var a=t[o],u=[],s=0;s<a.length;s++){for(var c=a[s],h=0,f=0;f<c.length;f++){var v=c[f];h+=e[f]*v}var d=l(i,o).output(h);u.push(d)}r.push(u),e=u}return r}function l(t,n){return"string"==typeof t?A[t]:Array.isArray(t)?A[t[n]]:void 0}function f(t,n){for(var i=0;i<t.length;i++)for(var e=t[i],r=0;r<e.length;r++)for(var o=e[r],a=0;a<o.length;a++){var u=o[a];n({weight:u,node:o,layer:e,network:t,path:[i,r,a]})}}function v(t){return JSON.parse(JSON.stringify(t))}function d(t,n){return JSON.stringify(t)===JSON.stringify(n)}function g(t){function n(){return l}function i(t){l=t}function e(t){return f=h(l,t,s.activation)}function r(t,n){var i=e(n);return s.output(i[i.length-1])}function o(t){for(var n=[],i=f[f.length-1],e=0;e<t.length;e++){var r=i[e]-t[e];n.push(r)}return p(l,n)}function a(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:s.learningRate,i=o(t);m(l,f,i,s.activation,n)}function u(t,n){e(t),a(n)}var s=Object.assign({},w,t),l=c(s.network),f=null;return{options:s,getNetwork:n,replaceNetwork:i,compute:e,adjust:a,train:u,output:r}}function p(t,n){for(var i=[n.concat()],e=n,r=t.length-2;r>=0;r--){for(var o=t[r],a=t[r+1],u=[],s=o.length-1;s>=0;s--){for(var c=0,h=a.length-1;h>=0;h--){var l=a[h][s];c+=e[h]*l}u.unshift(c)}i.unshift(u),e=u}return i}function m(t,n,i,e,r){f(t,function(o){var a=o.path,u=t[a[0]][a[1]][a[2]],s=n[a[0]][a[2]],c=n[a[0]+1][a[1]],h=i[a[0]][a[1]],f=l(e,a[0]),v=-r*h*s*f.derivative(c),d=u+v;t[a[0]][a[1]][a[2]]=d})}function k(t){function n(t){for(var n=0;n<t;n++){var i=c(f.network);d.push(i)}f.amount=d.length}function i(t){d.forEach(t)}function e(t){var i=d.length;i>t?(d.length=t,f.amount=t):i<t&&n(t-i)}function r(){return d}function o(t){d=t}function a(t){for(var n=[],i=0;i<t.length;i++)n.push(d[t[i]]);d=n,f.amount=d.length}function u(t,n){return h(d[t],n,f.activation)}function s(t,n){var i=u(t,n);return f.output(i[i.length-1])}function l(t){t&&a(t);for(var n=[],i=Math.round(f.elitismRate*f.amount),e=0;e<i;e++)n.push(d[e]);for(var r=Math.round(f.randomRate*f.amount),o=0;o<r;o++)n.push(c(f.network));for(var u=0;;){for(var s=0;s<u;s++)for(var h=0;h<f.mixNumber;h++){var l=y(v(d[s]),d[u],f.mutation);if(n.push(l),n.length>=f.amount)return n.length=f.amount,void(d=n)}u++,u===d.length&&(u=0)}}var f=Object.assign({},S,t),d=[];return n(f.amount),{options:f,createNetworks:n,eachNetwork:i,getNetworks:r,replaceNetworks:o,sortNetworks:a,updateAmount:e,compute:u,adjust:l,output:s}}function y(i,e,r){return f(i,function(o){var a=o.path;if(n()){var u=e[a[0]][a[1]][a[2]];i[a[0]][a[1]][a[2]]=u}Math.random()<=r.rate&&(i[a[0]][a[1]][a[2]]+=r.range*t())}),i}var A={RELU:{output:e,derivative:r},SIGMOID:{output:o,derivative:a},TANH:{output:u,derivative:s}},b=Object.freeze({create:c,compute:h,getActivation:l,walk:f,copy:v,isEqual:d}),w={network:[2,2,1],activation:"SIGMOID",learningRate:.1,output:i},S={network:[2,2,1],amount:50,elitismRate:.2,randomRate:.2,mixNumber:1,mutation:{rate:.1,range:.5},activation:"SIGMOID",output:i},M=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},x=function(){function t(t,n){for(var i=0;i<n.length;i++){var e=n[i];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(n,i,e){return i&&t(n.prototype,i),e&&t(n,e),n}}(),B=function(){function t(n){M(this,t),this.originalBoard=n,this.statistic=[]}return x(t,[{key:"run",value:function(t){for(var n=Number(t),i=this.originalBoard.getActions(),e=0;e<i.length;e++)for(var r=Math.floor(n/i.length);r--;)this.simulate(i[e]);return this.getBestAction()}},{key:"simulate",value:function(t){var n=this.originalBoard.clone();n.doAction(t);for(var i=n.getActions();i.length;){var e=i[Math.floor(Math.random()*i.length)];n.doAction(e),i=n.getActions()}this.updateStatistic(t,n.getResult())}},{key:"updateStatistic",value:function(t,n){var i=this.statistic.find(function(n){return n.action===t});i?(i.score+=n,i.visited+=1):this.statistic.push({action:t,score:n,visited:1})}},{key:"getBestAction",value:function(){return this.statistic.map(function(t){return{action:t.action,quality:t.score/t.visited}}).reduce(function(t,n){return n.quality>t.quality?n:t}).action}}]),t}(),C=function(){function t(n){M(this,t),this.originalBoard=n,this.board=null}return x(t,[{key:"run",value:function(t){for(var n=Number(t),i=new N(null,this.originalBoard.getActions(),null);n--;){this.board=this.originalBoard.clone();var e=i;e=this.Selection(e),e=this.Expanstion(e),this.Simulation(e),this.Backpropagation(e)}return i.getBestAction()}},{key:"Selection",value:function(t){for(;!t.hasUnexaminedAction()&&t.children.length>0;)t=t.selectChild(),this.board.doAction(t.action);return t}},{key:"Expanstion",value:function(t){if(t.hasUnexaminedAction()){var n=t.getUnexamineActionRandomly();this.board.doAction(n),t=t.addChild(n,this.board.getActions())}return t}},{key:"Simulation",value:function(t){for(var n=this.board.getActions();n.length>0;){var i=n[Math.floor(Math.random()*n.length)];this.board.doAction(i),n=this.board.getActions()}}},{key:"Backpropagation",value:function(t){t.updateStatistic(this.board.getResult())}}]),t}(),N=function(){function t(n,i){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;M(this,t),this.action=n,this.nextActions=i||[],this.children=[],this.wins=0,this.visits=0,this.parent=e}return x(t,[{key:"isRoot",value:function(){return!this.parent}},{key:"hasUnexaminedAction",value:function(){return this.nextActions.length>0}},{key:"getUnexamineActionRandomly",value:function(){var t=Math.floor(Math.random()*this.nextActions.length);return this.nextActions.splice(t,1)[0]}},{key:"getScore",value:function(){return this.visits>0?this.wins/this.visits:0}},{key:"getBestChild",value:function(){for(var t=this.children[0],n=1;n<this.children.length;n++){var i=this.children[n];i.getScore()>t.getScore()&&(t=i)}return t}},{key:"getBestAction",value:function(){return this.getBestChild().action}},{key:"addChild",value:function(n,i){var e=new t(n,i,this);return this.children.push(e),e}},{key:"selectChild",value:function(){return this.children[Math.floor(Math.random()*this.children.length)]}},{key:"updateStatistic",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.visits+=1,this.wins+=t,this.isRoot()||this.parent.updateStatistic(t)}}]),t}(),R=function(){function t(n){M(this,t),this.originalBoard=n,this.board=null}return x(t,[{key:"run",value:function(t){for(var n=Number(t),i=new U(null,this.originalBoard.getActions(),null);n--;){this.board=this.originalBoard.clone();var e=i;e=this.Selection(e),e=this.Expanstion(e),this.Simulation(e),this.Backpropagation(e)}return i.getBestAction()}},{key:"Selection",value:function(t){for(;!t.hasUnexaminedAction()&&t.children.length>0;)t=t.selectChild(),this.board.doAction(t.action);return t}},{key:"Expanstion",value:function(t){if(t.hasUnexaminedAction()){var n=t.getUnexamineActionRandomly();this.board.doAction(n),t=t.addChild(n,this.board.getActions())}return t}},{key:"Simulation",value:function(t){for(var n=this.board.getActions();n.length>0;){var i=n[Math.floor(Math.random()*n.length)];this.board.doAction(i),n=this.board.getActions()}}},{key:"Backpropagation",value:function(t){t.updateStatistic(this.board.getResult())}}]),t}(),U=function(){function t(n,i){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;M(this,t),this.action=n,this.nextActions=i||[],this.children=[],this.wins=0,this.visits=0,this.parent=e}return x(t,[{key:"isRoot",value:function(){return!this.parent}},{key:"hasUnexaminedAction",value:function(){return this.nextActions.length>0}},{key:"getUnexamineActionRandomly",value:function(){var t=Math.floor(Math.random()*this.nextActions.length);return this.nextActions.splice(t,1)[0]}},{key:"getScore",value:function(){return this.visits>0?this.wins/this.visits:0}},{key:"getBestChild",value:function(){for(var t=this.children[0],n=1;n<this.children.length;n++){var i=this.children[n];i.visits>t.visits?t=i:i.visits===t.visits&&(t=i.wins>t.wins?i:t)}return t}},{key:"getBestAction",value:function(){return this.getBestChild().action}},{key:"getUCTValue",value:function(){return this.getScore()+this.parent.getScore()*Math.sqrt(2*Math.log(this.parent.visits)/this.visits)}},{key:"addChild",value:function(n,i){var e=new t(n,i,this);return this.children.push(e),e}},{key:"selectChild",value:function(){for(var t=this.children[0],n=1;n<this.children.length;n++){var i=this.children[n];i.getUCTValue()>t.getUCTValue()&&(t=i)}return t}},{key:"updateStatistic",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.visits+=1,this.wins+=t,this.isRoot()||this.parent.updateStatistic(t)}}]),t}();return{network:b,createBackPropagation:g,createEvolution:k,MCM:B,MCTS:C,UCT:R}});